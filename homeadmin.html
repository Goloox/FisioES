<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Panel Admin • FISIOES</title>

  <!-- Bootstrap / FA -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">

  <!-- Estilos existentes -->
  <link rel="stylesheet" href="CSS/style.css">
  <link rel="stylesheet" href="CSS/navbar.css">
  <link rel="icon" href="Img/logo.jpg" type="image/jpg">

  <style>
    .avatar{width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,.6);background:#222}
    .avatar:hover{opacity:.9;cursor:pointer}
  </style>

  <!-- Guard de sesión (sin tocar el DOM aún) -->
  <script>
  (function checkAuth() {
    const token = localStorage.getItem('token');
    const userStr = localStorage.getItem('user');

    if (!token || !userStr) {
      location.href = 'login.html';
      return;
    }
    try {
      const user = JSON.parse(userStr);
      if (user?.rol_id !== 1) {
        location.href = 'homecliente.html';
      }
    } catch (e) {
      localStorage.clear();
      location.href = 'login.html';
    }
  })();
  </script>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center gap-2" href="Default.html">
      <img src="Img/logo.jpg" alt="FISIOES" style="height:40px;width:40px;border-radius:6px;object-fit:cover;">
      <span class="fw-semibold">FISIOES</span>
    </a>
    <div class="ms-auto d-flex align-items-center gap-3">
      <img id="avatarImg" class="avatar" alt="Avatar">
      <span id="adminName" class="text-white-50 small"></span>
      <a href="admin-usuarios.html" class="btn btn-outline-primary btn-sm"><i class="fa-solid fa-user-gear me-1"></i> Usuarios</a>
      <a href="profile.html" class="btn btn-outline-secondary btn-sm"><i class="fa-solid fa-id-badge me-1"></i> Perfil</a>
      <button id="btnLogout" class="btn btn-outline-light btn-sm"><i class="fa-solid fa-right-from-bracket me-1"></i> Salir</button>
    </div>
  </div>
</nav>

<header class="py-5 text-white" style="background-image:url('Img/fisioes.jpg'); background-size:cover; background-position:center;">
  <div class="container">
    <h1 class="display-6 fw-bold text-shadow-sm mb-0">Panel de administración</h1>
    <p class="lead mt-2 mb-0">Gestiona usuarios, citas y contenido</p>
  </div>
</header>

<main class="py-5">
  <div class="container">
    <!-- Resumen -->
    <div class="row g-4">
      <div class="col-12 col-md-6 col-lg-3">
        <div class="card border-0 shadow-sm rounded-4">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="me-3 fs-2 text-primary"><i class="fa-solid fa-users"></i></div>
              <div>
                <div class="text-muted small">Usuarios</div>
                <div id="statUsuarios" class="h5 mb-0">—</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-6 col-lg-3">
        <div class="card border-0 shadow-sm rounded-4">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="me-3 fs-2 text-success"><i class="fa-solid fa-calendar-check"></i></div>
              <div>
                <div class="text-muted small">Citas (hoy)</div>
                <div id="statCitasHoy" class="h5 mb-0">—</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-6 col-lg-3">
        <div class="card border-0 shadow-sm rounded-4">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="me-3 fs-2 text-warning"><i class="fa-solid fa-video"></i></div>
              <div>
                <div class="text-muted small">Videos</div>
                <div id="statVideos" class="h5 mb-0">—</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-6 col-lg-3">
        <div class="card border-0 shadow-sm rounded-4">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="me-3 fs-2 text-info"><i class="fa-solid fa-shield-heart"></i></div>
              <div>
                <div class="text-muted small">Sesión</div>
                <div id="statSesion" class="h6 mb-0">—</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Acciones rápidas -->
    <div class="row g-4 mt-1">
      <div class="col-12 col-lg-8">
        <div class="card border-0 shadow-sm rounded-4">
          <div class="card-body">
            <h2 class="h5 mb-3">Acciones rápidas</h2>
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <a href="admin-usuarios.html" class="btn btn-outline-primary w-100">
                  <i class="fa-solid fa-user-gear me-2"></i> Gestionar usuarios
                </a>
              </div>
              <div class="col-12 col-md-6">
                <a href="admin-citas.html" class="btn btn-outline-success w-100">
                  <i class="fa-solid fa-calendar-days me-2"></i> Gestionar citas
                </a>
              </div>
              <div class="col-12 col-md-6">
                <a href="admin-videos.html" class="btn btn-outline-warning w-100">
                  <i class="fa-solid fa-video me-2"></i> Gestionar videos
                </a>
              </div>
              <div class="col-12 col-md-6">
                <a href="profile.html" class="btn btn-outline-secondary w-100">
                  <i class="fa-solid fa-sliders me-2"></i> Perfil
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Últimos accesos / actividad -->
      <div class="col-12 col-lg-4">
        <div class="card border-0 shadow-sm rounded-4">
          <div class="card-body">
            <h2 class="h6 mb-3">Estado</h2>
            <ul class="list-unstyled small mb-0" id="estadoList">
              <li>Verificando sesión…</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

  </div>
</main>

<footer class="footer py-3 border-top">
  <div class="container text-center">
    <small>© <span id="year"></span> FISIOES — Todos los derechos reservados</small>
  </div>
</footer>

<!-- Script de guardia y UI (se ejecuta cuando el DOM ya existe) -->
<script>
(function(){
  document.getElementById('year').textContent = new Date().getFullYear();

  const adminNameEl = document.getElementById('adminName');
  const estadoList = document.getElementById('estadoList');
  const avatarEl = document.getElementById('avatarImg');
  const FALLBACK = 'Img/default-avatar.png';

  function decodeJwt(token){
    try{
      const payload = token.split('.')[1];
      const json = atob(payload.replace(/-/g,'+').replace(/_/g,'/'));
      return JSON.parse(decodeURIComponent(escape(json)));
    }catch(e){ return null; }
  }

  const token = localStorage.getItem('token');
  const userStr = localStorage.getItem('user');

  if(!token){
    location.href = 'login.html';
    return;
  }

  const payload = decodeJwt(token);
  const now = Math.floor(Date.now()/1000);

  if(!payload || !payload.exp || payload.exp <= now){
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    location.href = 'login.html';
    return;
  }

  const user = (() => {
    try { return JSON.parse(userStr || '{}'); } catch { return {}; }
  })();

  const rolId = payload.rol_id ?? user.rol_id;
  if(rolId !== 1){
    location.href = 'homecliente.html';
    return;
  }

  const nombre = user?.nombre_completo || payload?.correo || 'Admin';
  adminNameEl.textContent = nombre;

  estadoList.innerHTML = `
    <li>Autenticado como <strong>${nombre}</strong></li>
    <li>Correo: <code>${payload.correo || user?.correo || ''}</code></li>
    <li>Rol: <span class="badge text-bg-primary">ADMIN</span></li>
    <li>Expira: ${new Date(payload.exp*1000).toLocaleString()}</li>
  `;

  // Cargar avatar con Authorization (sin exponer el JWT en la URL)
  async function loadMyAvatar(){
    try{
      const r = await fetch('/.netlify/functions/avatar?me=1', {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      if(!r.ok) throw new Error('no avatar');
      const blob = await r.blob();
      avatarEl.src = URL.createObjectURL(blob);
    }catch{
      avatarEl.src = FALLBACK;
    }
    avatarEl.onerror = ()=> avatarEl.src = FALLBACK;
  }
  loadMyAvatar();

  avatarEl.addEventListener('click', ()=> location.href = 'profile.html');

  // Stats placeholder
  document.getElementById('statUsuarios').textContent = '—';
  document.getElementById('statCitasHoy').textContent = '—';
  document.getElementById('statVideos').textContent = '—';
  document.getElementById('statSesion').textContent = 'Activa';

  // Logout
  document.getElementById('btnLogout').addEventListener('click', () => {
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    location.href = 'login.html';
  });
})();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
