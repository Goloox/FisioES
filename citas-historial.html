<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Historial de citas • FISIOES</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
  <style>
    .thumb{width:90px;height:70px;object-fit:cover;border-radius:6px;border:1px solid rgba(0,0,0,.08);background:#f2f2f2}
  </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center gap-2" href="homecliente.html">
      <img src="Img/logo.jpg" alt="FISIOES" style="height:40px;width:40px;border-radius:6px;object-fit:cover;">
      <span class="fw-semibold">FISIOES</span>
    </a>
    <div class="ms-auto">
      <a class="btn btn-outline-light btn-sm" href="agendar-cita.html"><i class="fa-solid fa-calendar-plus me-1"></i> Agendar</a>
      <button id="logoutBtn" class="btn btn-danger btn-sm ms-2"><i class="fa-solid fa-right-from-bracket"></i> Salir</button>
    </div>
  </div>
</nav>

<header class="py-5 bg-info text-white">
  <div class="container">
    <h1 class="h3 mb-0"><i class="fa-solid fa-clock-rotate-left me-2"></i>Historial de citas</h1>
  </div>
</header>

<main class="container py-4">
  <div id="wrap"><div class="text-muted">Cargando…</div></div>
</main>

<!-- Modal imagen -->
<div class="modal fade" id="imgModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <img id="imgModalPic" alt="" style="width:100%;height:auto;border-radius:0.5rem">
    </div>
  </div>
</div>

<footer class="footer py-3 border-top">
  <div class="container text-center">
    <small>© <span id="year"></span> FISIOES</small>
  </div>
</footer>

<script>
// Convierte "YYYY-MM-DD HH:MM:SS" o "YYYY-MM-DDTHH:MM:SS" (con o sin 'Z')
// a una fecha local SIN desplazamiento de zona.
function parseSqlTimestampAsLocal(s) {
  if (!s || typeof s !== 'string') return null;
  // Limpia: quita 'Z' si viene, cambia espacio por 'T'
  const clean = s.replace('Z','').replace(' ', 'T');
  // yyyy-mm-ddThh:mm[:ss]
  const m = clean.match(/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})(?::(\d{2}))?/);
  if (!m) return null;
  const [_, yy, MM, dd, hh, mm, ss] = m;
  // new Date(año, mesIndex, dia, hora, minuto, segundo) crea fecha LOCAL
  return new Date(
    Number(yy), Number(MM) - 1, Number(dd),
    Number(hh), Number(mm), Number(ss || 0)
  );
}

// Formatea como string legible local, sin mover la hora
function formatLocal(sqlTs, withSeconds = false) {
  const d = parseSqlTimestampAsLocal(sqlTs);
  if (!d) return sqlTs || '-';
  return d.toLocaleString(undefined, {
    year: 'numeric', month: '2-digit', day: '2-digit',
    hour: '2-digit', minute: '2-digit', ...(withSeconds ? { second:'2-digit' } : {}),
    hour12: true
  });
}

// Si quieres SOLO hora (HH:00 AM/PM):
function formatLocalTime(sqlTs) {
  const d = parseSqlTimestampAsLocal(sqlTs);
  if (!d) return '-';
  return d.toLocaleTimeString(undefined, { hour:'2-digit', minute:'2-digit', hour12:true });
}
</script>

<script>
document.getElementById('year').textContent = new Date().getFullYear();

const token = localStorage.getItem('token');
const rawUser = localStorage.getItem('usuario') || localStorage.getItem('user');
if (!token || !rawUser) location.href = 'login.html';
let user = {}; try{ user = JSON.parse(rawUser || '{}'); }catch{}
if (Number(user.rol_id) === 1) location.href = 'Default.html';

document.getElementById('logoutBtn').onclick = ()=>{ localStorage.clear(); location.href='login.html'; };

function statusBadge(e){
  switch (Number(e)) {
    case 1: return '<span class="badge text-bg-success">Aceptado</span>';
    case 2: return '<span class="badge text-bg-danger">Cancelado</span>';
    case 3: return '<span class="badge text-bg-warning text-dark">En espera</span>';
    case 4: return '<span class="badge text-bg-secondary">Pospuesto</span>';
    case 5: return '<span class="badge text-bg-primary">Finalizada</span>';
    default: return '<span class="badge text-bg-light text-dark">—</span>';
  }
}

function imgClick(src){
  const pic = document.getElementById('imgModalPic');
  pic.src = src;
  const m = new bootstrap.Modal('#imgModal');
  m.show();
}

async function load(){
  const wrap = document.getElementById('wrap');
  wrap.innerHTML = '<div class="text-muted">Cargando…</div>';
  try{
    const r = await fetch('/.netlify/functions/citas_list_me', {
      headers:{ Authorization:'Bearer '+token }
    });
    const t = await r.text(); let data=null; try{ data=JSON.parse(t);}catch{}
    if(!r.ok){ wrap.innerHTML = `<div class="text-danger">${data?.error||t||'Error'}</div>`; return; }
    const rows = data.rows||[];
    if(!rows.length){ wrap.innerHTML = '<div class="alert alert-info">Aún no tienes citas.</div>'; return; }

    const acc = document.createElement('div');
    acc.className = 'accordion';
    acc.id = 'accordionCitas';

    rows.forEach((c,i)=>{
      const hId = 'h'+c.id_cita, bId = 'b'+c.id_cita;
      const item = document.createElement('div');
      item.className = 'accordion-item';
      item.innerHTML = `
        <h2 class="accordion-header" id="${hId}">
          <button class="accordion-button ${i? 'collapsed':''}" type="button" data-bs-toggle="collapse" data-bs-target="#${bId}">
            <div class="me-2">${statusBadge(c.estado)}</div>
            <div class="me-2 badge text-bg-secondary">${formatLocal(c.fecha)}</div>
            <strong>${c.titulo}</strong>
          </button>
        </h2>
        <div id="${bId}" class="accordion-collapse collapse ${i? '':'show'}" data-bs-parent="#accordionCitas">
          <div class="accordion-body">
            <p class="mb-2">${c.descripcion || '<span class="text-muted">Sin descripción</span>'}</p>

            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="small text-muted">ID cita: ${c.id_cita}</div>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-warning" data-action="posponer" data-id="${c.id_cita}" ${([2,5].includes(Number(c.estado)))?'disabled':''}>
                  <i class="fa-solid fa-clock-rotate-left me-1"></i> Posponer
                </button>
                <button class="btn btn-outline-danger" data-action="cancelar" data-id="${c.id_cita}" ${([2,5].includes(Number(c.estado)))?'disabled':''}>
                  <i class="fa-solid fa-xmark me-1"></i> Cancelar
                </button>
              </div>
            </div>

            ${c.images && c.images.length
              ? `<div class="d-flex flex-wrap gap-2">${c.images.map(id=>{
                  const src = '/.netlify/functions/cita_image?id='+id+'&jwt='+encodeURIComponent(token);
                  return `<a href="${src}" target="_blank" onclick="event.preventDefault(); imgClick('${src}')"><img class="thumb" src="${src}" alt=""></a>`;
                }).join('')}</div>`
              : '<div class="text-muted">Sin imágenes</div>'}
          </div>
        </div>`;
      acc.appendChild(item);
    });

    wrap.innerHTML = '';
    wrap.appendChild(acc);

    // Handlers cancelar/posponer
    wrap.querySelectorAll('[data-action]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const id = Number(btn.dataset.id);
        const action = btn.dataset.action;
        const estado = (action==='cancelar') ? 2 : 4; // cancelar=2, posponer=4
        if (estado===2 && !confirm('¿Cancelar esta cita?')) return;
        if (estado===4 && !confirm('¿Solicitar posponer esta cita?')) return;
        const res = await fetch('/.netlify/functions/cita_set_estado', {
          method:'POST',
          headers:{ 'Authorization':'Bearer '+token, 'Content-Type':'application/json' },
          body: JSON.stringify({ id_cita:id, estado })
        });
        const tt = await res.text(); let dd=null; try{ dd=JSON.parse(tt);}catch{}
        if(!res.ok){ alert(dd?.error||tt||'No se pudo actualizar'); return; }
        load();
      });
    });

  }catch{
    wrap.innerHTML = '<div class="text-danger">Error de red.</div>';
  }
}

load();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
