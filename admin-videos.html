<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Añadir videos • FISIOES</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="CSS/style.css"><link rel="stylesheet" href="CSS/navbar.css">
<link rel="icon" href="Img/logo.jpg" type="image/jpg">
<script>
(function(){
  const t=localStorage.getItem('token'), u=localStorage.getItem('user');
  if(!t||!u) return location.href='login.html';
  try{ if(JSON.parse(u).rol_id!==1) location.href='homecliente.html'; }catch{ localStorage.clear(); location.href='login.html';}
})();
</script>
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center gap-2" href="homeadmin.html">
      <img src="Img/logo.jpg" style="height:40px;width:40px;border-radius:6px;object-fit:cover;">
      <span class="fw-semibold">FISIOES • Admin</span>
    </a>
    <div class="ms-auto d-flex gap-2">
      <a href="admin-videos-asignar.html" class="btn btn-outline-info btn-sm"><i class="fa-solid fa-list-check me-1"></i> Asignar videos</a>
      <a href="admin-usuarios.html" class="btn btn-outline-primary btn-sm"><i class="fa-solid fa-user-gear me-1"></i> Usuarios</a>
      <button id="btnLogout" class="btn btn-outline-light btn-sm"><i class="fa-solid fa-right-from-bracket me-1"></i> Salir</button>
    </div>
  </div>
</nav>

<main class="container py-4">
  <h1 class="h4 mb-3">Añadir video</h1>

  <div class="card border-0 shadow-sm rounded-4 mb-4">
    <div class="card-body">
      <form id="formVid" class="row g-3" enctype="multipart/form-data">
        <div class="col-12 col-md-4">
          <label class="form-label">Objetivo</label>
          <input required name="objetivo" id="objetivo" class="form-control" placeholder="Fortalecer hombro…">
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">Título</label>
          <input required name="titulo" id="titulo" class="form-control" placeholder="Rotación externa…">
        </div>
        <div class="col-12 col-md-4">
          <label class="form-label">Archivo de video</label>
          <input required name="file" id="file" type="file" accept="video/*" class="form-control">
        </div>
        <div class="col-12 d-grid d-md-flex gap-2">
          <button class="btn btn-warning"><i class="fa-solid fa-circle-plus me-1"></i> Guardar</button>
          <a class="btn btn-outline-secondary" href="admin-videos-asignar.html"><i class="fa-solid fa-list-check me-1"></i> Ir a asignar</a>
        </div>
      </form>
      <div id="msg" class="small mt-2"></div>
    </div>
  </div>

  <div class="card border-0 shadow-sm rounded-4">
    <div class="card-body">
      <div class="row g-2 align-items-end">
        <div class="col-12 col-md-6">
          <label class="form-label small">Buscar</label>
          <input id="q" class="form-control" placeholder="Título u objetivo">
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label small">Por página</label>
          <select id="pageSize" class="form-select"><option>10</option><option>20</option><option>50</option></select>
        </div>
        <div class="col-6 col-md-2 d-grid">
          <button id="btnBuscar" class="btn btn-primary"><i class="fa-solid fa-magnifying-glass me-1"></i> Buscar</button>
        </div>
      </div>

      <div class="table-responsive mt-3">
        <table class="table table-sm align-middle">
          <thead><tr><th>#</th><th>Título</th><th>Objetivo</th><th>Archivo</th><th>Creado</th><th class="text-end">Acciones</th></tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="d-flex justify-content-between align-items-center">
        <div class="small text-muted" id="totalLbl">0</div>
        <div class="btn-group">
          <button id="prev" class="btn btn-outline-secondary btn-sm">&laquo;</button>
          <span id="pageLbl" class="btn btn-outline-secondary btn-sm disabled">1</span>
          <button id="next" class="btn btn-outline-secondary btn-sm">&raquo;</button>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
(function(){
  const token = localStorage.getItem('token');
  document.getElementById('btnLogout').addEventListener('click', ()=>{ localStorage.clear(); location.href='login.html'; });

  const msg = document.getElementById('msg');
  function say(text, ok=true){ msg.textContent = text; msg.className = 'small mt-2 ' + (ok?'text-success':'text-danger'); }

  async function readJsonOrText(res){
    const text = await res.text();
    let data = null; try { data = JSON.parse(text); } catch {}
    return { ok: res.ok, status: res.status, data, text };
  }

  // crear (multipart)
  document.getElementById('formVid').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(e.target);
    const res = await fetch('/.netlify/functions/video_upload', {
      method:'POST',
      headers:{ 'Authorization':'Bearer '+token },
      body: fd
    });
    const {ok, data, text} = await readJsonOrText(res);
    if(!ok){ say(data?.error || text || 'Error subiendo video', false); return; }
    say('Video subido (#'+data.id_video+')');
    e.target.reset();
    load();
  });

  // eliminar video
  async function deleteVideo(id){
    if(!confirm('¿Eliminar este video? Esto quitará también asignaciones.')) return;
    const res = await fetch('/.netlify/functions/video_delete', {
      method:'POST',
      headers:{ 'Authorization':'Bearer '+token, 'Content-Type':'application/json' },
      body: JSON.stringify({ id_video: id })
    });
    const {ok, data, text} = await readJsonOrText(res);
    if(!ok){ alert(data?.error || text || 'No se pudo eliminar'); return; }
    load();
  }

  // listar
  const tbody = document.getElementById('tbody');
  const q = document.getElementById('q'), pageSizeEl = document.getElementById('pageSize');
  const totalLbl = document.getElementById('totalLbl'), pageLbl = document.getElementById('pageLbl');
  const prev = document.getElementById('prev'), next = document.getElementById('next');
  let page = 1;

  async function load(){
    const params = new URLSearchParams({ page, pageSize: pageSizeEl.value, q: q.value.trim() });
    const res = await fetch('/.netlify/functions/video_list?'+params.toString(), { headers:{ 'Authorization':'Bearer '+token } });
    const {ok, data, text} = await readJsonOrText(res);
    if(!ok){ tbody.innerHTML=''; totalLbl.textContent = text || 'Error'; return; }
    tbody.innerHTML = '';
    data.rows.forEach((v,idx)=>{
      const stream = `/.netlify/functions/video_stream?id=${v.id_video}&jwt=${encodeURIComponent(token)}`;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${(data.page-1)*data.pageSize + idx + 1}</td>
        <td>${v.titulo}</td>
        <td>${v.objetivo}</td>
        <td>${Number(v.has_file) ? `<a class="btn btn-sm btn-outline-primary" href="${stream}" target="_blank"><i class="fa-solid fa-play me-1"></i> Ver</a>` : '<span class="badge text-bg-secondary">Sin archivo</span>'}</td>
        <td>${new Date(v.created_at).toLocaleString()}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-danger" data-id="${v.id_video}"><i class="fa-solid fa-trash me-1"></i> Eliminar</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
    tbody.querySelectorAll('button.btn-outline-danger').forEach(b=>{
      b.addEventListener('click', ()=>deleteVideo(Number(b.dataset.id)));
    });
    totalLbl.textContent = `${data.total} resultado(s)`;
    pageLbl.textContent = data.page;
    prev.disabled = data.page<=1;
    next.disabled = data.page*data.pageSize >= data.total;
  }

  document.getElementById('btnBuscar').addEventListener('click', ()=>{ page=1; load(); });
  prev.addEventListener('click', ()=>{ if(page>1){ page--; load(); }});
  next.addEventListener('click', ()=>{ page++; load(); });

  load();
})();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
